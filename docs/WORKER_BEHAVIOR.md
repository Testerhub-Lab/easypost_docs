# WORKER_BEHAVIOR.md

## Назначение воркера

Воркер является микросервисом для обработки очередей BullMQ, предназначенным для отправки сообщений в Telegram, уведомлений о расписании и массовых рассылок. Он взаимодействует с backend API для выполнения этих задач и обеспечивает надежную обработку заданий с поддержкой ретраев и логирования.

## Очереди, джобы, кроны и триггеры

### Очереди

1. **postQueue**
   - **Назначение**: Обработка отправки сообщений в Telegram.
   - **Структура задания**:
     ```typescript
     {
       botId: string;
       channelId: string;
       text?: string;
       attachments?: AttachmentJobItem[];
       mediaUrl?: string;
       token?: string;
       telegramId?: string;
       postId?: string;
       parse_mode?: string;
       linkPreviewOptions?: object;
       link_preview_options?: object;
     }
     ```
   - **Параметры**:
     - Попытки: 5
     - Backoff: экспоненциальный, начиная с 3 секунд
     - Concurrency: 10
     - Rate limit: 50 запросов/секунду
     - Remove on fail: false
     - Remove on complete: true

2. **scheduleQueue**
   - **Назначение**: Обработка уведомлений о расписании.
   - **Структура задания**:
     ```typescript
     {
       eventId: string;
       userId?: string;
       courseId?: string;
     }
     ```
   - **Параметры**:
     - Попытки: 5
     - Backoff: экспоненциальный, начиная с 3 секунд
     - Concurrency: 20
     - Rate limit: 100 запросов/секунду
     - Remove on fail: false
     - Remove on complete: true

3. **broadcastQueue**
   - **Назначение**: Массовая рассылка сообщений.
   - **Структура задания**:
     ```typescript
     {
       botId: string;
       text: string;
       userIds: string[];
     }
     ```
   - **Параметры**:
     - Попытки: 5
     - Backoff: экспоненциальный, начиная с 3 секунд
     - Concurrency: 1
     - Rate limit: 30 запросов/секунду
     - Remove on fail: false
     - Remove on complete: true

### Триггеры

- **postQueue**: Задания добавляются в очередь при создании или обновлении поста в статусе `SCHEDULED`.
- **scheduleQueue**: Задания добавляются в очередь для отправки уведомлений о расписании.
- **broadcastQueue**: Задания добавляются в очередь для массовой рассылки сообщений.

## Жизненный цикл поста

1. **Draft**: Пост создан, но не запланирован.
2. **Scheduled**: Пост запланирован и ожидает отправки.
3. **Queued**: Пост добавлен в очередь для отправки.
4. **Sent**: Пост успешно отправлен.
5. **Failed**: Пост не удалось отправить.

### Ретраи и таймауты

- **Ретраи**: Все очереди поддерживают автоматический retry с экспоненциальным backoff. Максимальное количество попыток: 5.
- **Таймауты**: Задания, которые не удается выполнить после 5 попыток, автоматически перемещаются в Dead-Letter Queue (DLQ) для дальнейшего анализа.

### Ошибки

- **400 Bad Request**: Ошибки клиента, такие как неверные данные или недопустимые запросы, не подлежат ретрай.
- **500 Internal Server Error**: Ошибки сервера, такие как временные сбои или проблемы с подключением, подлежат ретрай.
- **Timeout**: Ошибки таймаута подлежат ретрай.

## Логирование ошибок

### Где логируются ошибки

- **Логи**: Ошибки логируются с использованием Pino. Логи могут быть записаны в файл или выведены в консоль в зависимости от конфигурации.
- **Dead-Letter Queue (DLQ)**: Задания, которые не удалось выполнить после всех попыток, перемещаются в DLQ для дальнейшего анализа.

### Типовые причины fail

1. **Ошибки валидации**: Неверные данные или недопустимые запросы.
2. **Ошибки подключения**: Проблемы с подключением к backend API или Redis.
3. **Ошибки Telegram API**: Ошибки при отправке сообщений в Telegram, такие как неверные токены или недоступные чаты.
4. **Таймауты**: Превышение времени ожидания при выполнении запросов.

## Примеры

### Пример лога ошибки

```json
{
  "level": "error",
  "time": "2025-12-01T10:00:00.000Z",
  "queue": "postQueue",
  "jobId": "123",
  "error": "Connection timeout",
  "stack": "Error: Connection timeout\n    at ...",
  "jobData": { "botId": "bot123", "channelId": "ch456" },
  "attemptsMade": 5,
  "msg": "[postQueue] Job 123 failed"
}
```

### Пример задания в DLQ

```typescript
{
  originalQueue: string;
  originalJobId: string;
  originalJobData: unknown;
  failureReason: string;
  attemptsMade: number;
  failedAt: string;
}
```

## Заключение

Воркер обеспечивает надежную обработку заданий для отправки сообщений в Telegram, уведомлений о расписании и массовых рассылок. Он поддерживает автоматический ретрай, логирование ошибок и перемещение неудачных заданий в DLQ для дальнейшего анализа.
